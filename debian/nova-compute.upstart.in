description "Nova compute worker"
author "Soren Hansen <soren@linux2go.dk>"

start on (filesystem and
          net-device-up IFACE!=lo and
          started libvirt-bin)
stop on runlevel [016]


chdir /var/run

pre-start script
	mkdir -p /var/run/nova
	chown nova:root /var/run/nova/

	mkdir -p /var/lock/nova
	chown nova:root /var/lock/nova/

	modprobe nbd
end script

script
    set +e
    runcon -t nova-compute_t /bin/true 2>&1 >/dev/null
    if [ $? -eq 0 ]; then
        start-stop-daemon --start --chuid nova --exec /usr/bin/runcon -- -t nova-compute_t /usr/bin/nova-compute --config-file=/etc/nova/nova.conf --config-file=/etc/nova/nova-compute.conf
    else
        start-stop-daemon --start --chuid nova --exec /usr/bin/nova-compute -- --config-file=/etc/nova/nova.conf --config-file=/etc/nova/nova-compute.conf
    fi
end script
